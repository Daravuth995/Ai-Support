<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ask Your English Tutor</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --primary: #00f0ff;
      --secondary: #7b2dff;
      --dark: #0a0a1a;
      --light: #e0f8ff;
      --accent: #ff2d7b;
      --glass: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--dark);
      color: var(--light);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Animated Circuit Background */
    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(135deg, var(--dark) 25%, transparent 25%) -50px 0,
        linear-gradient(225deg, var(--dark) 25%, transparent 25%) -50px 0,
        linear-gradient(315deg, var(--dark) 25%, transparent 25%),
        linear-gradient(45deg, var(--dark) 25%, transparent 25%);
      background-size: 100px 100px;
      background-color: rgba(11, 4, 32, 0.8);
      opacity: 0.8;
      z-index: -2;
      animation: circuitMove 60s linear infinite;
    }

    @keyframes circuitMove {
      0% { background-position: 0 0, 0 0, 0 0, 0 0; }
      100% { background-position: 2000px 0, 2000px 0, 2000px 0, 2000px 0; }
    }

    /* Floating dots animation */
    body::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, var(--primary) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.1;
      z-index: -1;
      animation: float 120s linear infinite;
    }

    @keyframes float {
      0% { background-position: 0 0; }
      100% { background-position: 1000px 1000px; }
    }

    header {
      background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,240,255,0.2) 50%, rgba(0,0,0,0) 100%);
      color: var(--primary);
      padding: 1.5rem;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      letter-spacing: 2px;
      text-shadow: 0 0 10px var(--primary), 0 0 20px rgba(0, 240, 255, 0.5);
      border-bottom: 1px solid rgba(0, 240, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      box-shadow: 0 0 10px var(--primary);
    }

    .section {
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      height: calc(100vh - 80px);
      overflow: hidden;
    }

    .section.active {
      display: flex;
      flex-direction: column;
      opacity: 1;
    }

    /* Login Section */
    #loginSection {
      justify-content: center;
      align-items: center;
    }

    .login-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(0, 240, 255, 0.2);
      padding: 2.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      transform: translateY(20px);
      animation: floatUp 0.8s ease-out forwards;
    }

    @keyframes floatUp {
      to { transform: translateY(0); }
    }

    .login-card::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        transparent 45%,
        rgba(0, 240, 255, 0.1) 50%,
        transparent 55%
      );
      animation: shine 3s infinite;
      z-index: -1;
    }

    @keyframes shine {
      0% { transform: rotate(0deg) translate(-30%, -30%); }
      100% { transform: rotate(360deg) translate(-30%, -30%); }
    }

    .login-title {
      font-family: 'Orbitron', sans-serif;
      color: var(--primary);
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.8rem;
      letter-spacing: 1px;
      text-shadow: 0 0 8px var(--primary);
    }

    .input-group {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .input-group::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    .input-group:focus-within::before {
      width: 100%;
    }

    input {
      background: rgba(10, 10, 26, 0.7);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 4px;
      padding: 0.8rem 1rem;
      width: 100%;
      color: var(--light);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.2);
    }

    input::placeholder {
      color: rgba(224, 248, 255, 0.5);
    }

    .login-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      border: none;
      border-radius: 4px;
      padding: 0.8rem;
      width: 100%;
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      font-size: 1rem;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin-top: 1rem;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 240, 255, 0.4);
    }

    .login-btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .login-btn:hover::before {
      left: 100%;
    }

    #loginLoading {
      display: none;
      margin-top: 1.5rem;
      text-align: center;
      color: var(--primary);
      font-family: 'Orbitron', sans-serif;
      position: relative;
    }

    .loading-bot {
      display: inline-block;
      margin-right: 10px;
    }

    .loading-bot span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-bot span:nth-child(1) { animation-delay: 0s; }
    .loading-bot span:nth-child(2) { animation-delay: 0.2s; }
    .loading-bot span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
      40% { transform: translateY(-10px); opacity: 1; }
    }

    /* Chat Section */
    #chatSection {
      padding: 0;
    }

    .user-info {
      background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,240,255,0.1) 50%, rgba(0,0,0,0) 100%);
      padding: 0.8rem 1.2rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 0.6rem;
      border-bottom: 1px solid rgba(0, 240, 255, 0.2);
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      letter-spacing: 1px;
      animation: slideDown 0.5s ease-out;
    }

    .user-info span {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--primary);
      border-radius: 20px;
      padding: 0.4rem 0.9rem;
      color: var(--primary);
      font-weight: bold;
      white-space: nowrap;
      box-shadow: 0 0 6px rgba(0, 240, 255, 0.4);
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .student-name {
      color: var(--primary);
      text-shadow: 0 0 5px var(--primary);
    }

    .points-display {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--primary);
      border-radius: 20px;
      padding: 0.3rem 1rem;
      color: var(--primary);
      font-weight: bold;
      animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px var(--primary); }
      50% { box-shadow: 0 0 15px var(--primary); }
    }

    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: rgba(10, 10, 26, 0.5);
    }

    /* Custom scrollbar */
    #chatBox::-webkit-scrollbar {
      width: 6px;
    }

    #chatBox::-webkit-scrollbar-track {
      background: rgba(0, 240, 255, 0.1);
    }

    #chatBox::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .msg {
      padding: 1rem 1.2rem;
      border-radius: 12px;
      max-width: 80%;
      position: relative;
      line-height: 1.5;
      animation: msgAppear 0.3s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes msgAppear {
      to { opacity: 1; transform: translateY(0); }
    }

    .user {
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      animation-delay: 0.1s;
    }

    .bot {
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid rgba(0, 240, 255, 0.3);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      animation-delay: 0.2s;
    }

    .user::after, .bot::after {
      content: "";
      position: absolute;
      bottom: 0;
      width: 20px;
      height: 15px;
      background-size: cover;
    }

    .user::after {
      right: -10px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"><path fill="%237b2dff" d="M20 15L0 0v15z"/></svg>');
    }

    .bot::after {
      left: -10px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"><path fill="%231e1e3c" d="M0 15l20-15v15z"/></svg>');
    }

    .typing-indicator {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 12px;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      position: relative;
    }

    .typing-indicator::after {
      content: "";
      position: absolute;
      left: -10px;
      bottom: 0;
      width: 20px;
      height: 15px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 15"><path fill="%231e1e3c" d="M0 15l20-15v15z"/></svg>');
      background-size: cover;
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      height: 20px;
    }

    .typing-dots span {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
      margin: 0 2px;
      animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing-bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-5px); }
    }

    .input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: rgba(10, 10, 26, 0.7);
      border-top: 1px solid rgba(0, 240, 255, 0.2);
    }

    #msgInput {
      flex: 1;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 20px;
      padding: 0.8rem 1.2rem;
      color: var(--light);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    #msgInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.2);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 240, 255, 0.4);
    }

    .send-btn i {
      font-size: 1.2rem;
    }

    /* Typing animation for bot messages */
    .typing {
      border-right: 2px solid var(--primary);
      animation: blink 0.7s step-end infinite;
    }

    @keyframes blink {
      from, to { border-color: transparent; }
      50% { border-color: var(--primary); }
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      header {
        font-size: 1.4rem;
        padding: 1rem;
      }
      
      .login-card {
        padding: 1.5rem;
        width: 95%;
      }
      
      .msg {
        max-width: 90%;
      }
    }

    /* New Enhancements */
    .welcome-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 10, 26, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeOut 1.5s ease-in-out 2s forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }

    .welcome-heading {
      font-family: 'Orbitron', sans-serif;
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-align: center;
      text-shadow: 0 0 15px var(--primary);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .welcome-subtext {
      color: var(--light);
      font-size: 1.2rem;
      margin-bottom: 2rem;
      text-align: center;
      max-width: 80%;
    }

    .welcome-loader {
      width: 80px;
      height: 80px;
      border: 5px solid rgba(0, 240, 255, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin-bottom: 2rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .points-change {
      position: relative;
      display: inline-block;
    }

    .points-change-animation {
      position: absolute;
      right: -30px;
      font-size: 0.8em;
      opacity: 0;
      animation: pointsFade 1.5s ease-out;
    }

    @keyframes pointsFade {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-30px); opacity: 0; }
    }

    .motivation-banner {
      background: linear-gradient(90deg, rgba(123,45,255,0.2) 0%, rgba(0,240,255,0.3) 50%, rgba(123,45,255,0.2) 100%);
      color: white;
      padding: 0.8rem;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      letter-spacing: 1px;
      border-top: 1px solid rgba(0, 240, 255, 0.3);
      border-bottom: 1px solid rgba(0, 240, 255, 0.3);
      animation: bannerSlide 0.5s ease-out;
    }

    @keyframes bannerSlide {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .suggested-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: center;
    }

    .suggested-question {
      background: rgba(0, 240, 255, 0.1);
      border: 1px solid rgba(0, 240, 255, 0.3);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      color: var(--light);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .suggested-question:hover {
      background: rgba(0, 240, 255, 0.2);
      transform: translateY(-2px);
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--primary);
      opacity: 0;
      z-index: 1000;
    }

    /* Math and code formatting */
    pre {
      background: #151525;
      color: #00f0ff;
      padding: 0.8rem 1rem;
      border-radius: 9px;
      font-size: 0.97rem;
      overflow-x: auto;
      margin: 1rem 0 0 0;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', 'monospace';
    }

    code {
      background: none;
      color: inherit;
      font-size: inherit;
      font-family: inherit;
    }

    .step-title {
      font-weight: bold;
      color: #00f0ff;
      margin: 1.3em 0 0.5em 0;
      font-size: 1.08em;
      letter-spacing: 0.5px;
    }

    ol, ul {
      margin: 0.4em 0 1.2em 2.1em;
      padding-left: 1em;
    }

    .math {
      font-family: 'Fira Mono', 'Consolas', monospace;
      color: #7b2dff;
      background: rgba(0,240,255,0.08);
      border-radius: 4px;
      padding: 0 3px;
    }

    .math-box {
      display: inline-block;
      margin-top: 1em;
      margin-bottom: 0.5em;
      background: #191933;
      border: 2px solid #00f0ff;
      border-radius: 8px;
      padding: 0.7em 1.1em;
      font-size: 1.12em;
      color: #00f0ff;
    }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <header>🤖 ASK YOUR ENGLISH TUTOR</header>

  <!-- Login Section -->
  <div id="loginSection" class="section active">
    <div class="login-card">
      <h2 class="login-title">AUTHENTICATION REQUIRED</h2>
      <div class="input-group">
        <input type="text" id="idInput" placeholder="Student ID" />
      </div>
      <div class="input-group">
        <input type="password" id="passInput" placeholder="Password" />
      </div>
      <button class="login-btn" onclick="login()">ACCESS SYSTEM</button>
      <div id="loginLoading" class="loading" style="display: none;">
        <div class="loading-bot">
          <span></span>
          <span></span>
          <span></span>
        </div>
        VERIFYING CREDENTIALS
      </div>
    </div>
  </div>

  <!-- Chat Section -->
  <div id="chatSection" class="section">
    <div class="user-info">
      <span class="student-name" id="studentNameDisplay"></span>
      <span class="points-display" id="pointsDisplay"></span>
      <span class="plan-display" id="planDisplay"></span>
      <span class="cost-display" id="costDisplay"></span>
    </div>
    <div id="chatBox"></div>
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type your question..." />
      <button class="send-btn" onclick="send()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Welcome Overlay (will be shown after login) -->
  <div id="welcomeOverlay" class="welcome-overlay" style="display: none;">
    <div class="welcome-loader"></div>
    <h1 class="welcome-heading">WELCOME <span id="welcomeName"></span>!</h1>
    <p class="welcome-subtext">Preparing your personalized learning experience</p>
  </div>

  <!-- Motivation Banner -->
  <div id="motivationBanner" class="motivation-banner" style="display: none;">
    <span id="motivationText">Keep going! Every question makes you better.</span>
  </div>

  <script>
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzrDPwsOB4GC3kMD85jls4PyMzTl6KWoRHRz1wuNE6NEIcuoqjrri3FU0eegFdoBM50wg/exec';
    let studentID = '', studentPassword = '', studentName = '', points = 0;
    let messageHistory = [];
    let isBotTyping = false;
    let previousPoints = 0;

    // Motivational messages
    const motivationalMessages = [
      "Great work! Your progress is impressive!",
      "Every question brings you closer to mastery!",
      "Learning is a journey - enjoy each step!",
      "Your dedication is inspiring!",
      "Keep asking great questions!",
      "Success is built one question at a time!",
      "You're making excellent progress today!",
      "Curiosity is the key to learning!"
    ];

    // Suggested questions
    const suggestedQuestions = [
      "How can I improve my pronunciation?",
      "What's the difference between present perfect and past simple?",
      "Can you explain phrasal verbs?",
      "How do I use articles (a, an, the) correctly?",
      "What are some common English idioms?",
      "Can you give me a writing exercise?",
      "How can I expand my vocabulary?",
      "What's the best way to practice listening?"
    ];

    function login() {
      studentID = document.getElementById('idInput').value.trim();
      studentPassword = document.getElementById('passInput').value.trim();
      const loading = document.getElementById('loginLoading');

      if (!studentID || !studentPassword) {
        alert("Please enter your Student ID and Password.");
        return;
      }

      loading.style.display = 'flex';
      loading.style.alignItems = 'center';
      loading.style.justifyContent = 'center';

      fetch(BACKEND_URL, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'login',
          id: studentID,
          password: studentPassword
        })
      })
      .then(res => res.json())
      .then(data => {
        loading.style.display = 'none';
        if (data.success) {
          studentName = data.name;
          points = data.points;
          previousPoints = points;
          
          // Show welcome overlay
          document.getElementById('welcomeName').textContent = studentName.split(" ")[0] || studentName;
          const welcomeOverlay = document.getElementById('welcomeOverlay');
          welcomeOverlay.style.display = 'flex';
          
          // After animation completes, show chat section
          setTimeout(() => {
            document.getElementById('studentNameDisplay').textContent = `STUDENT: ${studentName.toUpperCase()}`;
            document.getElementById('pointsDisplay').textContent = `POINTS: ${points}`;
            
            // Check restriction
            fetch(BACKEND_URL, {
              method: 'POST',
              body: new URLSearchParams({
                action: 'getRestriction',
                id: studentID
              })
            })
            .then(res => res.json())
            .then(restriction => {
              if (restriction.restricted) {
                showRestrictionModal(restriction.message);
              } else {
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('chatSection').classList.add('active');
                
                // Show welcome message
                const welcomeMessage = `👋 Hello ${studentName.split(" ")[0]}, I'm your English Tutor. What would you like to practice today?`;
                appendMsg(welcomeMessage, 'bot');
                
                // Show motivation banner
                showMotivationalMessage();
                
                // Show suggested questions
                showSuggestedQuestions();
              }
            })
            .catch(() => {
              alert("Failed to check restriction. Please try again later.");
            });
          }, 3500); // Match this with the welcome overlay animation duration
        } else {
          alert("Login failed. Please check your credentials and try again.");
        }
      })
      .catch(err => {
        loading.style.display = 'none';
        alert("Network error. Please check your connection.");
      });
    }

    function showMotivationalMessage() {
      const banner = document.getElementById('motivationBanner');
      const textElement = document.getElementById('motivationText');
      
      // Show banner
      banner.style.display = 'block';
      
      // Change message every 30 seconds
      setInterval(() => {
        const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
        textElement.textContent = randomMessage;
        
        // Add slight animation
        banner.style.opacity = '0';
        setTimeout(() => {
          textElement.textContent = randomMessage;
          banner.style.opacity = '1';
        }, 500);
      }, 30000);
    }

    function showSuggestedQuestions() {
      const chatBox = document.getElementById('chatBox');
      const suggestionsContainer = document.createElement('div');
      suggestionsContainer.className = 'suggested-questions';
      
      // Add 3 random suggested questions
      const shuffled = [...suggestedQuestions].sort(() => 0.5 - Math.random());
      const selectedQuestions = shuffled.slice(0, 3);
      
      selectedQuestions.forEach(question => {
        const questionElement = document.createElement('div');
        questionElement.className = 'suggested-question';
        questionElement.textContent = question;
        questionElement.onclick = () => {
          document.getElementById('msgInput').value = question;
          send();
        };
        suggestionsContainer.appendChild(questionElement);
      });
      
      chatBox.appendChild(suggestionsContainer);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updatePointsDisplay(newPoints) {
      const pointsDisplay = document.getElementById('pointsDisplay');
      const pointsChange = newPoints - previousPoints;
      
      // Update display
      pointsDisplay.textContent = `POINTS: ${newPoints}`;
      
      // Show animation if points changed
      if (pointsChange !== 0) {
        const changeElement = document.createElement('span');
        changeElement.className = 'points-change-animation';
        changeElement.textContent = (pointsChange > 0 ? '+' : '') + pointsChange;
        changeElement.style.color = pointsChange > 0 ? '#00ff88' : '#ff2d7b';
        
        const container = document.createElement('span');
        container.className = 'points-change';
        container.textContent = pointsDisplay.textContent;
        container.appendChild(changeElement);
        
        pointsDisplay.textContent = '';
        pointsDisplay.appendChild(container);
        
        // Create confetti for positive points change
        if (pointsChange > 0) {
          createConfetti();
        }
      }
      
      previousPoints = newPoints;
    }

    function createConfetti() {
      const colors = ['#00f0ff', '#7b2dff', '#ff2d7b', '#00ff88', '#ffcc00'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        confetti.style.opacity = Math.random() * 0.5 + 0.5;
        
        document.body.appendChild(confetti);
        
        // Animation
        const animation = confetti.animate([
          { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
          { transform: `translateY(${Math.random() * 200 + 100}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
          duration: Math.random() * 2000 + 1000,
          easing: 'cubic-bezier(0.1,0.8,0.9,1)'
        });
        
        animation.onfinish = () => confetti.remove();
      }
    }

    function formatBotText(text) {
      // Headings and steps
      text = text.replace(/(?:^|\n)(Step[- ]?by[- ]?step:|Step \d+:|Final answer:|Combine them:|Conclusion:|Solution:)/gi,
        '<div class="step-title">$1</div>');

      // Numbered lists
      text = text.replace(/(?:^|\n)(\d+\.\s[^\n]+)/g, function(m, p1) {
        return `<li>${p1.trim()}</li>`;
      });
      if (text.includes('<li>')) text = '<ol>' + text + '</ol>';

      // Bulleted lists
      text = text.replace(/(?:^|\n)[*•\-] ([^\n]+)/g, function(m, p1) {
        return `<li>${p1.trim()}</li>`;
      });
      if (text.match(/<li>/) && !text.match(/<ol>/)) text = `<ul>${text}</ul>`;

      // Box "Final answer" or block math
      text = text.replace(/\\\[([^\]]+)\\\]/g, '<div class="math-box">\\[$1\\]</div>');
      text = text.replace(/(f'\(x\)\s*=\s*[^\n]+)/gi, '<div class="math-box">\\($1\\)</div>');

      // Inline math
      text = text.replace(/\\\((.+?)\\\)/g, '<span class="math">\\($1\\)</span>');

      // Markdown bold
      text = text.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');

      // Code blocks
      text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

      // Line breaks
      text = text.replace(/\n/g, '<br>');

      return text;
    }

    function appendMsg(content, sender, isTyping = false) {
      const chatBox = document.getElementById('chatBox');

      // Remove typing indicator if needed
      if (sender === 'bot' && isTyping) {
        const existingTyping = chatBox.querySelector('.typing-indicator');
        if (existingTyping) chatBox.removeChild(existingTyping);
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        const dotsDiv = document.createElement('div');
        dotsDiv.className = 'typing-dots';
        dotsDiv.innerHTML = '<span></span><span></span><span></span>';
        typingDiv.appendChild(dotsDiv);
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return typingDiv;
      }

      const div = document.createElement('div');
      div.className = `msg ${sender}`;

      // Format bot messages with special formatting
      if (!isTyping && sender === 'bot') {
        div.innerHTML = formatBotText(content);
      } else {
        div.textContent = content;
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      // MathJax render for bot messages
      if (sender === 'bot' && window.MathJax) {
        MathJax.typesetPromise([div]);
      }

      return div;
    }

    function send() {
      const msg = document.getElementById('msgInput').value.trim();
      if (!msg || isBotTyping) return;

      // Prevent sending if out of points
      if (points <= 0) {
        const lastMsg = document.querySelector('#chatBox .msg.bot:last-child');
        const warningText = "⚠️ You have no points left to ask questions. Please top up or earn more points.";

        if (!lastMsg || lastMsg.textContent.trim() !== warningText) {
          appendMsg(warningText, 'bot');
        }

        return;
      }

      appendMsg(msg, 'user');
      document.getElementById('msgInput').value = '';

      // Show typing indicator
      isBotTyping = true;
      appendMsg('', 'bot', true);

      // Save user's message to history
      if (messageHistory.length === 0) {
        const studentPlan = document.getElementById('planDisplay').textContent.includes("Advanced") ? "Advanced" : "Standard";
        const firstName = studentName.split(" ")[0] || studentName;

        const systemPrompt = studentPlan === "Advanced"
          ? `You are a friendly and helpful English tutor. The student's name is ${firstName} and their plan is Advanced. Use more advanced vocabulary and grammar explanations. Offer deeper insights and occasional follow-up questions. Keep responses informative but not too long. Always call the student by name. Teacher: Daravuth Yon.`
          : `You are a friendly and helpful English tutor. The student's name is ${firstName} and their plan is Standard. Use simple language and short, clear responses. Avoid complex grammar or deep explanations. Be encouraging and supportive. Always call the student by name. Teacher: Daravuth Yon.`;

        messageHistory.push({ role: "system", content: systemPrompt });
      }

      messageHistory.push({ role: "user", content: msg });

      fetch(BACKEND_URL, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'askGPT',
          id: studentID,
          password: studentPassword,
          message: msg,
          messageHistory: JSON.stringify(messageHistory)
        })
      })
      .then(res => res.json())
      .then(data => {
        isBotTyping = false;
        document.querySelectorAll('.typing-indicator').forEach(indicator => indicator.remove());
        
        if (data.success) {
          const botMsg = appendMsg(data.reply, 'bot');
          messageHistory.push({ role: "assistant", content: data.reply });

          // Update points with animation
          if (data.pointsLeft !== undefined) {
            updatePointsDisplay(data.pointsLeft);
            points = data.pointsLeft;
          }

          // Plan and cost handling
          if (data.plan) {
            document.getElementById('planDisplay').textContent = `Plan: ${data.plan}`;
          }
          if (typeof data.chatCostUsed !== "undefined") {
            document.getElementById('costDisplay').textContent = `Cost: ${data.chatCostUsed} pts/msg`;
          }
        } else {
          appendMsg(data.message, 'bot');
        }
      })
      .catch(err => {
        isBotTyping = false;
        document.querySelectorAll('.typing-indicator').forEach(indicator => indicator.remove());
        appendMsg("Sorry, I encountered an error. Please try again.", 'bot');
      });
    }

    // Allow sending message with Enter key
    document.getElementById('msgInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        send();
      }
    });

    function showRestrictionModal(msg) {
      document.getElementById('restrictionMessage').textContent = msg;
      document.getElementById('restrictionOverlay').style.display = 'block';
      document.getElementById('restrictionModal').style.display = 'block';
    }

    function closeRestriction() {
      document.getElementById('restrictionModal').style.display = 'none';
      document.getElementById('restrictionOverlay').style.display = 'none';
      location.reload();
    }
  </script>

  <!-- Restriction Modal -->
  <div id="restrictionOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;backdrop-filter:blur(6px);background:rgba(10,14,36,0.5);z-index:9999;"></div>
  <div id="restrictionModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);min-width:320px;max-width:90vw;padding:2rem 1.5rem;background:rgba(0,0,0,0.92);border-radius:18px;border:1.5px solid #00f0ff;color:#00f0ff;box-shadow:0 8px 48px rgba(0,0,0,0.6);font-family:'Orbitron',sans-serif;z-index:10000;text-align:center;">
    <div style="font-size:2.2rem;margin-bottom:0.7rem;">🚫</div>
    <div id="restrictionMessage" style="margin-bottom:1.2rem;font-size:1.15rem;"></div>
    <button onclick="closeRestriction()" style="margin-top:0.8rem;background:#00f0ff;color:#0a0a1a;padding:0.7rem 2.2rem;border:none;border-radius:24px;font-weight:bold;font-family:'Orbitron',sans-serif;font-size:1rem;cursor:pointer;box-shadow:0 2px 18px #00f0ff30;">OK</button>
  </div>
</body>
</html>
